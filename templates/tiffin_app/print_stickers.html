{% extends 'tiffin_app/base.html' %}
{% block title %}Print Stickers{% endblock %}
{% block page_title %}Print Stickers{% endblock %}

{% block top_actions %}
<button onclick="printStickers()" class="btn btn-primary">üñ®Ô∏è Print</button>
{% endblock %}

{% block extra_css %}
<style>
/* =========================================================
   Sticker Page (namespaced)
========================================================= */
.sticker-page{ width: 100%; }

/* ‚úÖ SCREEN */
@media screen{
  .sticker-page .print-page{
    width: 100%;
    min-height: auto;
    margin: 0 0 18px 0;
    padding: 0;
    background: transparent;
    border-radius: 0;
    box-shadow: none;
  }
}

/* ‚úÖ PRINT */
@media print{
  @page { size: A4; margin: 5mm; }
  .no-print { display: none !important; }
  .sticker-page .print-page { page-break-after: always; break-after: page; }
  .sticker-page .print-page:last-child { page-break-after: auto; break-after: auto; }
  body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .main-content { padding: 0 !important; }
  .card { box-shadow: none !important; border: none !important; }
}

/* Layout vars */
.sticker-page{ --sticker-size: 39mm; --sticker-gap: 1mm; }
.sticker-page .layout-35{ --sticker-size: 39mm; --sticker-gap: 1mm; }
.sticker-page .layout-24{ --sticker-size: 48mm; --sticker-gap: 2mm; }
.sticker-page .layout-12{ --sticker-size: 65mm; --sticker-gap: 3mm; }

/* Wrapper */
.sticker-page .stickers-wrap{
  width: 100%;
  max-width: none !important;
  margin: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
}

/* Grid */
.sticker-page .stickers-grid{
  width: 100%;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  align-items: start;
  justify-content: start;
  align-content: start;
}

.sticker-page .stickers-grid.per-35{
  grid-template-columns: repeat(5, var(--sticker-size)) !important;
  grid-auto-rows: var(--sticker-size) !important;
  gap: var(--sticker-gap) !important;
  place-content: start !important;
}
.sticker-page .stickers-grid.per-24{
  grid-template-columns: repeat(4, var(--sticker-size)) !important;
  grid-auto-rows: var(--sticker-size) !important;
  gap: var(--sticker-gap) !important;
  place-content: start !important;
}
.sticker-page .stickers-grid.per-12{
  grid-template-columns: repeat(3, var(--sticker-size)) !important;
  grid-auto-rows: var(--sticker-size) !important;
  gap: var(--sticker-gap) !important;
  place-content: start !important;
}

/* =========================================================
   Sticker (better use of empty space)
========================================================= */
.sticker-page .sticker{
  width: var(--sticker-size);
  height: var(--sticker-size);
  background: #fff !important;
  color: #111827 !important;
  border: 0.25mm solid #111 !important;
  border-radius: 2.2mm;
  padding: 1.2mm;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: none !important;

  position: relative;            /* ‚úÖ for watermark */
}

/* ‚úÖ Big watermark (uses empty space nicely) */
.sticker-page .sticker::before{
  content: attr(data-meal);      /* LUNCH / DINNER */
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  letter-spacing: 2px;
  transform: rotate(-12deg);
  opacity: .08;
  pointer-events: none;
  z-index: 0;
  text-transform: uppercase;
}

/* Header */
.sticker-page .sticker-header{
  background: var(--primary) !important;
  color: #fff !important;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
  border-radius: 2mm;
  padding: 1.0mm 1.1mm;
  display: flex;
  flex-direction: column;
  gap: 0.6mm;
  z-index: 2;
}

.sticker-page .sticker-customer{
  font-weight: 900;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.05;
}

.sticker-page .sticker-location{
  font-weight: 800;
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: .95;
  line-height: 1.05;
}

/* Body: center content so it doesn't look empty */
.sticker-page .sticker-body{
  flex: 1 1 auto;
  min-height: 0;
  display: flex;
  align-items: center;            /* ‚úÖ center vertically */
  justify-content: flex-start;    /* ‚úÖ left aligned (uses space nicely) */
  padding: 2.5mm 1.5mm 1.5mm 1.5mm;
  z-index: 2;
}

/* Meal block */
.sticker-page .meal-block{
  width: 100%;
}

.sticker-page .meal-label{
  font-weight: 900;
  color: #111827;
  opacity: .75;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.sticker-page .meal-value{
  font-weight: 1000;
  color: #111827;
  text-transform: uppercase;
  line-height: 1.05;
  margin-top: 1mm;
}

/* A nice divider line to balance empty space */
.sticker-page .meal-divider{
  margin-top: 2mm;
  height: 0;
  border-top: 0.2mm dashed #cbd5e1;
  width: 80%;
}

/* =========================================================
   FONT SIZES by layout
========================================================= */
.sticker-page .per-35 .sticker-customer{ font-size: 7.3pt !important; }
.sticker-page .per-35 .sticker-location{ font-size: 6.4pt !important; }
.sticker-page .per-35 .meal-label{ font-size: 6.2pt !important; }
.sticker-page .per-35 .meal-value{ font-size: 14.5pt !important; }
.sticker-page .per-35 .sticker::before{ font-size: 20pt !important; }

.sticker-page .per-24 .sticker-customer{ font-size: 9.2pt !important; }
.sticker-page .per-24 .sticker-location{ font-size: 8.0pt !important; }
.sticker-page .per-24 .meal-label{ font-size: 7.2pt !important; }
.sticker-page .per-24 .meal-value{ font-size: 18pt !important; }
.sticker-page .per-24 .sticker::before{ font-size: 28pt !important; }

.sticker-page .per-12 .sticker-customer{ font-size: 11.5pt !important; }
.sticker-page .per-12 .sticker-location{ font-size: 10pt !important; }
.sticker-page .per-12 .meal-label{ font-size: 8.6pt !important; }
.sticker-page .per-12 .meal-value{ font-size: 24pt !important; }
.sticker-page .per-12 .sticker::before{ font-size: 40pt !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-content sticker-page">
  <div class="card no-print">
    <div class="card-body">
      <form id="stickerFilters" method="get" class="filters" style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;">
        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">Date</label>
          <input id="dateInput" type="date" name="date" class="form-control" value="{{ entry_date }}" required>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">Meal Type</label>
          <select name="meal_type" class="form-control">
            <option value="LUNCH" {% if meal_type == 'LUNCH' %}selected{% endif %}>Lunch</option>
            <option value="DINNER" {% if meal_type == 'DINNER' %}selected{% endif %}>Dinner</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">Layout</label>
          <select name="layout" id="layoutSelect" class="form-control">
            <option value="35" {% if per_page == 35 %}selected{% endif %}>35 (A4 5√ó7 ~40mm)</option>
            <option value="24" {% if per_page == 24 %}selected{% endif %}>24 (A4 4√ó6 medium)</option>
            <option value="12" {% if per_page == 12 %}selected{% endif %}>12 (A4 3√ó4 large)</option>
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="8"  {% if per_page == 8 %}selected{% endif %}>8</option>
            <option value="6"  {% if per_page == 6 %}selected{% endif %}>6</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary" style="height:42px; padding:0 22px;">
          Generate
        </button>
      </form>
    </div>
  </div>

  {% for page in sticker_pages %}
    <div class="print-page">
      <div class="stickers-wrap">
        <div class="stickers-grid per-{{ per_page }} layout-{{ per_page }}">
          {% for data in page %}
            <div class="sticker" data-meal="{{ meal_type }}">
              <div class="sticker-header">
                <div class="sticker-customer">{{ data.entry.customer.name }}</div>
                <div class="sticker-location">{{ data.entry.customer.delivery_location }}</div>
              </div>

              <div class="sticker-body">
                <div class="meal-block">
                  <div class="meal-label">Meal</div>
                  <div class="meal-value">{{ meal_type }}</div>
                  <div class="meal-divider"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="empty-state" style="grid-column: 1/-1;">
      <div class="empty-state-icon">üì¶</div>
      <div class="empty-state-text">No orders found for selected criteria</div>
      <div class="empty-state-hint">Try selecting a different date or meal type</div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  function printStickers(){ window.print(); }

  document.addEventListener("DOMContentLoaded", function () {
    const dateInput = document.getElementById("dateInput");
    const form = document.getElementById("stickerFilters");

    if (dateInput) {
      const pad = (n) => String(n).padStart(2, "0");
      const now = new Date();
      const today = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      dateInput.setAttribute("max", today);

      const clampIfFuture = () => {
        const v = dateInput.value;
        if (v && v > today) dateInput.value = today;
      };

      dateInput.addEventListener("change", clampIfFuture);
      if (form) form.addEventListener("submit", clampIfFuture);
      clampIfFuture();
    }
  });
</script>
{% endblock %}
