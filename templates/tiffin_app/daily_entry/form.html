{% extends 'tiffin_app/base.html' %}
{% block title %}Create Order{% endblock %}
{% block page_title %}Create Order{% endblock %}

{% block content %}
<div class="main-content">
  <div class="card">
    <div class="card-body">
      <form method="post" id="createOrderForm">
        {% csrf_token %}

        <div class="form-group">
          <label class="form-label">Entry Date *</label>
          <input
            type="date"
            name="entry_date"
            class="form-control"
            value="{{ entry_date|default:today }}"
            required
            id="entry-date"
          >
        </div>

        <div class="form-group">
          <label class="form-label">Meal Type *</label>
          <select name="meal_type" class="form-control" required id="meal-type">
            <option value="LUNCH" {% if meal_type == "LUNCH" %}selected{% endif %}>Lunch</option>
            <option value="DINNER" {% if meal_type == "DINNER" %}selected{% endif %}>Dinner</option>
          </select>
        </div>

        <!-- ✅ Daily Menu Dropdown (optional) -->
        <div class="form-group">
          <label class="form-label">Daily Menu (optional)</label>
          <select name="daily_menu" class="form-control" id="daily-menu">
            <option value="">No menu (show all dishes)</option>

            {% for m in menus %}
              <option value="{{ m.id }}"
                {% if selected_menu_id == m.id|stringformat:"s" %}selected{% endif %}>
                {{ m.label }}
              </option>
            {% empty %}
              <option value="" disabled>No menu found for this date/meal type</option>
            {% endfor %}
          </select>
        </div>

        <!-- ✅ Customer Search + Select -->
        <div class="form-group">
          <label class="form-label">Customer *</label>

          <!-- search box -->
          <input
            type="text"
            id="customer-search"
            class="form-control"
            placeholder="Search customer name / location..."
            autocomplete="off"
            style="margin-bottom:10px;"
          />

          <!-- actual select used for submit -->
          <select name="customer" class="form-control" required id="customer-select">
            <option value="">Select Customer</option>
            {% for customer in customers %}
              <option value="{{ customer.pk }}">
                {{ customer.name }}
                ({% if customer.daily_customer %}Regular{% else %}Occasional{% endif %})
                - {{ customer.delivery_location }}
              </option>
            {% endfor %}
          </select>

          <div class="form-help" id="customer-help" style="margin-top:6px;">
            Tip: Type to filter customers quickly.
          </div>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">Create Order</button>
          <a href="{% url 'daily_entry_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ✅ when date / meal type changes => reload page with GET params (menus update)
  const dateEl = document.getElementById("entry-date");
  const mealEl = document.getElementById("meal-type");

  function reloadForMenus() {
    const params = new URLSearchParams(window.location.search);
    params.set("entry_date", dateEl.value || "");
    params.set("meal_type", mealEl.value || "LUNCH");
    params.delete("menu_id"); // reset selection when date/type changes
    window.location.search = params.toString();
  }

  dateEl.addEventListener("change", reloadForMenus);
  mealEl.addEventListener("change", reloadForMenus);


  // ✅ Searchable customer dropdown (no library)
  (function () {
    const searchEl = document.getElementById("customer-search");
    const selectEl = document.getElementById("customer-select");
    const helpEl = document.getElementById("customer-help");
    if (!searchEl || !selectEl) return;

    const placeholder = selectEl.querySelector('option[value=""]');
    const original = Array.from(selectEl.querySelectorAll("option"))
      .filter(o => o.value); // only real customers

    const data = original.map(o => ({
      value: o.value,
      text: o.textContent.trim(),
      key: o.textContent.trim().toLowerCase()
    }));

    const rebuild = (q) => {
      const query = (q || "").trim().toLowerCase();
      const prev = selectEl.value;

      // clear and re-add placeholder
      selectEl.innerHTML = "";
      if (placeholder) selectEl.appendChild(placeholder);

      const filtered = !query
        ? data
        : data.filter(x => x.key.includes(query));

      for (const x of filtered) {
        const opt = document.createElement("option");
        opt.value = x.value;
        opt.textContent = x.text;
        selectEl.appendChild(opt);
      }

      // restore selection if still present
      const stillExists = Array.from(selectEl.options).some(o => o.value === prev);
      selectEl.value = stillExists ? prev : "";

      if (helpEl) {
        helpEl.textContent = `Showing ${filtered.length} customer(s)`;
      }
    };

    const debounce = (fn, ms) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    };

    const onType = debounce(() => rebuild(searchEl.value), 120);
    searchEl.addEventListener("input", onType);

    // initial text
    rebuild("");
  })();
</script>
{% endblock %}
