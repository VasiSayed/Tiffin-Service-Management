{% extends 'tiffin_app/base.html' %}
{% block title %}Order Detail{% endblock %}
{% block page_title %}Order Detail - {{ entry.customer.name }}{% endblock %}

{% block content %}
<div class="main-content">

  <!-- Header -->
  <div class="card">
    <div class="card-header">
      <div class="flex-between">
        <div>
          <h2 class="card-title">{{ entry.customer.name }}</h2>
          <p class="text-muted">{{ entry.customer.delivery_location }}</p>
        </div>
        <div class="text-right">
          <div>
            <span class="badge badge-info">{{ entry.get_meal_type_display }}</span>
            <span class="badge badge-warning">{{ entry.entry_date }}</span>
          </div>
          <div class="mt-2"><strong>Total: ₹{{ entry.total_amount }}</strong></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Meal -->
  <div class="card mt-3">
    <div class="card-header">
      <h2 class="card-title">Add Meal to Order</h2>
    </div>
    <div class="card-body">

      <form method="post" action="{% url 'order_meal_add' entry.pk %}"
            style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;">
        {% csrf_token %}

        <div class="form-group" style="flex:2; min-width:260px; margin-bottom:0;">
          <label class="form-label">Meal</label>
          <select name="meal" class="form-control" required style="width:100%;">
            <option value="">Select Meal</option>
            {% for meal in meals %}
              <option value="{{ meal.pk }}">{{ meal.name }} - ₹{{ meal.price }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group" style="width:130px; margin-bottom:0;">
          <label class="form-label">Qty</label>
          <input type="number" name="qty" class="form-control" value="1" min="1" style="width:100%;">
        </div>

        <button type="submit" class="btn btn-primary" style="height:42px; padding:0 22px;">
          Add Meal
        </button>
      </form>

    </div>
  </div>

  <!-- Existing Meals -->
  {% for order_meal in entry.order_meals.all %}
    <div class="card mt-3">
      <div class="card-header">
        <div class="flex-between">
          <div>
            <h3 style="font-size:1.1rem;margin:0;">{{ order_meal.meal.name }} x{{ order_meal.qty }}</h3>
            <p class="text-muted" style="margin:4px 0 0;">
              ₹{{ order_meal.unit_price }} × {{ order_meal.qty }} =
              <strong>₹{{ order_meal.total_price }}</strong>
            </p>
          </div>

          <form method="post" action="{% url 'order_meal_delete' order_meal.pk %}"
                onsubmit="return confirmDelete('Remove meal?')">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger" style="height:38px; padding:0 18px;">
              Delete Meal
            </button>
          </form>
        </div>
      </div>

      <div class="card-body">
        <h4 style="font-size:0.95rem;margin-bottom:12px;">Included Items</h4>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Dish Name</th>
                <th style="width:110px;">Qty</th>
                <th style="width:140px;">Source</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order_meal.custom_items.all %}
                <tr>
                  <td>
                    {{ item.dish_name }}
                    {% if item.portion %} ({{ item.portion.portion_label }}){% endif %}
                  </td>
                  <td>{{ item.qty }}</td>
                  <td>
                    <span class="badge badge-{% if item.source == 'TEMPLATE' %}info{% else %}warning{% endif %}">
                      {{ item.get_source_display }}
                    </span>
                  </td>
                  <td>
                    <form method="post" action="{% url 'custom_item_delete' item.pk %}"
                          style="display:inline;" onsubmit="return confirmDelete('Remove item?')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" style="height:34px; padding:0 14px;">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-center">No items added</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- ✅ FIXED ALIGNMENT: Add Custom Item -->
        <div style="margin-top:18px; padding-top:14px; border-top:1px solid #eef2f7;">
          <form method="post" action="{% url 'custom_item_add' order_meal.pk %}"
                style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;">
            {% csrf_token %}

            <div class="form-group" style="flex:2; min-width:260px; margin-bottom:0;">
              <label class="form-label">Dish (optional)</label>
              <select name="dish" class="form-control" style="width:100%;">
                <option value="">Select Dish (or use manual name)</option>
                {% for dish in dishes %}
                  <option value="{{ dish.pk }}">{{ dish.name }} ({{ dish.get_category_display }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group" style="flex:2; min-width:220px; margin-bottom:0;">
              <label class="form-label">Manual Name (optional)</label>
              <input type="text" name="manual_name" class="form-control" placeholder="e.g., Papad" style="width:100%;">
            </div>

            <div class="form-group" style="width:130px; margin-bottom:0;">
              <label class="form-label">Qty</label>
              <input type="number" name="qty" class="form-control" value="1" min="1" style="width:100%;">
            </div>

            <button type="submit" class="btn btn-primary" style="height:42px; padding:0 22px;">
              Add Item
            </button>
          </form>
        </div>

      </div>
    </div>

  {% empty %}
    <div class="empty-state mt-3">
      <div class="empty-state-text">No meals added to this order yet</div>
      <div class="empty-state-hint">Use the form above to add meals</div>
    </div>
  {% endfor %}

  <div class="mt-3">
    <a href="{% url 'daily_entry_list' %}" class="btn btn-secondary">Back to Daily Entry</a>
  </div>

</div>

<script>
function confirmDelete(msg){ return confirm(msg || "Are you sure?"); }
</script>
{% endblock %}
