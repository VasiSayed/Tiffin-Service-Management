{% extends 'tiffin_app/base.html' %}
{% block title %}Customer Orders{% endblock %}
{% block page_title %}Customer Orders{% endblock %}

{% block top_actions %}
  <a class="btn btn-secondary"
     href="{% url 'reports' %}?start_date={{ start_date }}&end_date={{ end_date }}">
    ← Back to Reports
  </a>
{% endblock %}

{% block content %}
<div class="main-content">

  <div class="card">
    <div class="card-body">

      <div style="margin-bottom:12px;">
        <h2 style="margin:0;">{{ customer.name }}</h2>
        <div style="opacity:.8;">
          {{ customer.delivery_location|default:"-" }} • {{ customer.contact_number|default:"-" }}
          • {% if customer.daily_customer %}Regular{% else %}Occasional{% endif %}
          • Meal: {{ customer.meal_preference|default:"BOTH" }}
        </div>
      </div>

      <!-- Filters -->
      <form method="get" class="filters" style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;">
        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>

        <button type="submit" class="btn btn-primary" style="height:42px; padding:0 22px;">
          Apply
        </button>
      </form>

    </div>
  </div>

  <!-- Summary -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Orders</div>
      <div class="stat-value">{{ total_orders }}</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">Total Spent</div>
      <div class="stat-value">₹{{ total_spent }}</div>
    </div>
    <div class="stat-card success">
      <div class="stat-label">Avg / Order</div>
      <div class="stat-value">₹{{ avg_order_value|floatformat:2 }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Lunch / Dinner</div>
      <div class="stat-value">{{ lunch_count }} / {{ dinner_count }}</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Orders (DailyEntry)</h2>
    </div>
    <div class="card-body card-body-compact">

      {% if entries %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Meal</th>
              <th>Menu</th>
              <th>Meals</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entries %}
            <tr>
              <td>{{ e.entry_date }}</td>
              <td>{{ e.meal_type }}</td>
              <td>
                {% if e.menu %}
                  {{ e.menu.menu_name|default:"-" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if e.order_meals.all %}
                  {% for om in e.order_meals.all %}
                    {{ om.meal.name }} x{{ om.qty }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>₹{{ e.total_amount }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div style="padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
          No orders found for this customer in selected date range.
        </div>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
